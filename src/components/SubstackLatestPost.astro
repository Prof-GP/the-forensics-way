---
// src/components/SubstackLatestPost.astro
export interface Props {
  substackUrl: string;
}

const { substackUrl } = Astro.props;

// Declare variables before try-catch
let posts: Array<{
  title: string;
  link: string;
  pubDate: string;
  description: string;
}> = [];
let error: string | null = null;

try {
  const rssUrl = substackUrl.endsWith('/') 
    ? `${substackUrl}feed` 
    : `${substackUrl}/feed`;
  
  const response = await fetch(rssUrl);
  
  if (!response.ok) {
    throw new Error('Failed to fetch RSS feed');
  }
  
  const rssText = await response.text();
  
  // Parse RSS items
  const itemMatches = [...rssText.matchAll(/<item>(.*?)<\/item>/gs)];
  
  posts = itemMatches.slice(0, 3).map(match => {
    const item = match[1];
    
    // Extract data
    const titleMatch = item.match(/<title>(?:<!\[CDATA\[)?(.*?)(?:\]\]>)?<\/title>/s);
    const linkMatch = item.match(/<link>(.*?)<\/link>/);
    const pubDateMatch = item.match(/<pubDate>(.*?)<\/pubDate>/);
    const descMatch = item.match(/<description>(?:<!\[CDATA\[)?(.*?)(?:\]\]>)?<\/description>/s);
    
    const title = titleMatch?.[1] || 'Untitled';
    const link = linkMatch?.[1] || '';
    const pubDate = pubDateMatch?.[1] || '';
    const description = descMatch?.[1] || '';
    
    // Clean HTML from description and truncate
    const plainText = description
      .replace(/<[^>]*>/g, '')
      .replace(/&nbsp;/g, ' ')
      .replace(/&amp;/g, '&')
      .replace(/&lt;/g, '<')
      .replace(/&gt;/g, '>')
      .trim()
      .substring(0, 150);
    
    // Format date
    const formattedDate = pubDate ? new Date(pubDate).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    }) : '';
    
    return {
      title: title.trim(),
      link: link.trim(),
      pubDate: formattedDate,
      description: plainText + (plainText.length >= 150 ? '...' : '')
    };
  });
} catch (e) {
  const errorMessage = e instanceof Error ? e.message : 'Unknown error';
  error = errorMessage;
  console.error('Error fetching Substack posts:', e);
}
---

<section class="substack-posts">
  <div class="section-header">
    <h2>Latest from Substack</h2>
    <a href={substackUrl} target="_blank" rel="noopener noreferrer" class="view-all">
      View All Posts →
    </a>
  </div>
  
  {error ? (
    <p class="error-message">Unable to load posts. Please check back later.</p>
  ) : posts.length > 0 ? (
    <div class="posts-grid">
      {posts.map(post => (
        <article class="post-card">
          <time class="post-date">{post.pubDate}</time>
          <h3 class="post-title">
            <a href={post.link} target="_blank" rel="noopener noreferrer">
              {post.title}
            </a>
          </h3>
          <p class="post-excerpt">{post.description}</p>
          <a href={post.link} class="read-more" target="_blank" rel="noopener noreferrer">
            Read on Substack →
          </a>
        </article>
      ))}
    </div>
  ) : (
    <p class="no-posts">No posts available yet.</p>
  )}
</section>

<style>
  .substack-posts {
    margin: 3rem 0;
    padding: 2rem 0;
  }
  
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    gap: 1rem;
  }
  
  .section-header h2 {
    font-size: 2rem;
    margin: 0;
  }
  
  .view-all {
    color: #667eea;
    text-decoration: none;
    font-weight: 500;
    font-size: 1rem;
  }
  
  .view-all:hover {
    text-decoration: underline;
  }
  
  .posts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
  }
  
  .post-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 1.5rem;
    transition: transform 0.3s, box-shadow 0.3s;
  }
  
  .post-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }
  
  .post-date {
    display: block;
    color: #666;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
  }
  
  .post-title {
    margin: 0 0 0.75rem 0;
    font-size: 1.25rem;
    line-height: 1.3;
  }
  
  .post-title a {
    color: #333;
    text-decoration: none;
  }
  
  .post-title a:hover {
    color: #667eea;
  }
  
  .post-excerpt {
    color: #555;
    line-height: 1.6;
    margin-bottom: 1rem;
    font-size: 0.95rem;
  }
  
  .read-more {
    color: #667eea;
    text-decoration: none;
    font-weight: 500;
    font-size: 0.9rem;
  }
  
  .read-more:hover {
    text-decoration: underline;
  }
  
  .error-message,
  .no-posts {
    text-align: center;
    color: #666;
    padding: 2rem;
    background: #f9f9f9;
    border-radius: 8px;
  }
  
  /* Dark mode */
  :root.dark .post-card {
    background-color: #1a1a1a;
    border-color: #333;
  }
  
  :root.dark .post-title a {
    color: #f5f5f5;
  }
  
  :root.dark .post-date {
    color: #aaa;
  }
  
  :root.dark .post-excerpt {
    color: #ccc;
  }
  
  :root.dark .error-message,
  :root.dark .no-posts {
    background: #1a1a1a;
    color: #aaa;
  }
  
  @media (max-width: 768px) {
    .posts-grid {
      grid-template-columns: 1fr;
    }
    
    .section-header {
      flex-direction: column;
      align-items: flex-start;
    }
  }
</style>